apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-policy
  namespace: dev-gateway-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: api-gateway
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-auth-ns
    ports:
    - protocol: TCP
      port: 8081
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-payment-ns
    ports:
    - protocol: TCP
      port: 8082
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-ai-content-ns
    ports:
    - protocol: TCP
      port: 8083
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-notification-ns
    ports:
    - protocol: TCP
      port: 8084
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-analytics-ns
    ports:
    - protocol: TCP
      port: 8085
  # Allow Redis access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 6379

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-policy
  namespace: dev-auth-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: auth-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-gateway-ns
    ports:
    - protocol: TCP
      port: 8081
  egress:
  # PostgreSQL access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 5432
  # Kafka access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 9092
  # External OAuth providers (Google, etc.)
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-service-policy
  namespace: dev-payment-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: payment-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-gateway-ns
    ports:
    - protocol: TCP
      port: 8082
  egress:
  # PostgreSQL access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 5432
  # RabbitMQ access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 5672
  # Kafka access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 9092
  # Stripe API access
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-content-service-policy
  namespace: dev-ai-content-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: ai-content-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-gateway-ns
    ports:
    - protocol: TCP
      port: 8083
  egress:
  # PostgreSQL access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 5432
  # OpenAI API access
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: notification-service-policy
  namespace: dev-notification-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: notification-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-gateway-ns
    ports:
    - protocol: TCP
      port: 8084
  egress:
  # PostgreSQL access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 5432
  # RabbitMQ access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 5672
  # Kafka access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 9092
  # Email service access (SMTP)
  - to: []
    ports:
    - protocol: TCP
      port: 587
  # Loki logging
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-logging-ns
    ports:
    - protocol: TCP
      port: 3100

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: analytics-service-policy
  namespace: dev-analytics-ns
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: analytics-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-gateway-ns
    ports:
    - protocol: TCP
      port: 8085
  egress:
  # PostgreSQL access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-database-ns
    ports:
    - protocol: TCP
      port: 5432
  # Kafka access
  - to:
    - namespaceSelector:
        matchLabels:
          name: dev-messaging-ns
    ports:
    - protocol: TCP
      port: 9092

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-access-policy
  namespace: dev-monitoring-ns
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  # Allow Prometheus to scrape metrics from all services
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-monitoring-ns
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
  # Allow Grafana access to Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: dev-monitoring-ns
      podSelector:
        matchLabels:
          app.kubernetes.io/name: grafana
    ports:
    - protocol: TCP
      port: 9090
  # Allow external access to Grafana
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000